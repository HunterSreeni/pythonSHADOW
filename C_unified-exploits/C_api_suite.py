#!/usr/bin/env python3
"""
SHADOW API Security Suite - Coordinated API-specific testing.

Coordinates (all Python-primary, no Kali equivalents):
- graphql_introspect.py (schema extraction, query building)
- oauth_discovery.py (OAuth/OIDC endpoint discovery, misconfiguration)
- openapi_discovery.py (Swagger/OpenAPI spec parsing)
- api_endpoint_extractor.py (REST API discovery, method enumeration)

Usage (CLI):
    python C_api_suite.py -t https://api.example.com -o results/
    python C_api_suite.py -t https://example.com --modules graphql,openapi

Usage (importable):
    from C_unified_exploits.C_api_suite import APISuite
    suite = APISuite(target="https://api.example.com")
    result = await suite.run()
"""

import argparse
import asyncio
import json
import sys
from pathlib import Path
from typing import Any, Dict, List, Optional

sys.path.insert(0, str(Path(__file__).parent.parent))

from core.utils import setup_logging, normalize_url, timestamp_now, ensure_dir
from C_wrappers.C_tool_router import ToolRouter, UnifiedResult

logger = setup_logging("api_suite")


class APISuite:
    """
    Coordinated API security testing suite.

    All Python-primary (no Kali tool equivalents for API-specific testing).
    Discovers and tests GraphQL, OAuth, OpenAPI, and REST API endpoints.
    """

    API_MODULES = ["graphql", "oauth", "openapi", "api_endpoints"]

    def __init__(
        self,
        target: str,
        output_dir: str = "results",
        modules: Optional[List[str]] = None,
        cookie: Optional[str] = None,
        auth_header: Optional[str] = None,
        timeout: int = 300,
        proxy: Optional[str] = None,
    ):
        self.target = normalize_url(target)
        self.output_dir = Path(output_dir)
        self.modules = [m.lower() for m in (modules or self.API_MODULES)]
        self.cookie = cookie
        self.auth_header = auth_header
        self.timeout = timeout
        self.proxy = proxy
        self.router = ToolRouter()

    async def run(self) -> UnifiedResult:
        """Run all requested API security tests."""
        logger.info(f"Starting API Security Suite for: {self.target}")
        result = UnifiedResult(tool_used="api_suite", target=self.target)
        all_findings: List[Dict[str, Any]] = []
        module_results: Dict[str, Any] = {}

        # API modules are independent, can run in parallel
        tasks = {}
        for mod in self.modules:
            if mod == "graphql":
                tasks[mod] = self._test_graphql()
            elif mod == "oauth":
                tasks[mod] = self._test_oauth()
            elif mod == "openapi":
                tasks[mod] = self._test_openapi()
            elif mod == "api_endpoints":
                tasks[mod] = self._test_api_endpoints()
            else:
                logger.warning(f"Unknown API module: {mod}")

        # Run tests
        for mod, coro in tasks.items():
            logger.info(f"Testing: {mod}")
            try:
                findings = await coro
                all_findings.extend(findings)
                module_results[mod] = {"findings_count": len(findings)}
                logger.info(f"  {mod}: {len(findings)} findings")
            except Exception as e:
                logger.error(f"  {mod} failed: {e}")
                module_results[mod] = {"error": str(e)}

        result.findings = all_findings
        result.parsed_data = {
            "modules_tested": self.modules,
            "total_findings": len(all_findings),
            "module_results": module_results,
        }

        return result

    async def _test_graphql(self) -> List[Dict[str, Any]]:
        """Test GraphQL endpoints - introspection, batching, depth limit."""
        return await self._run_python_module(
            "phase2_discovery.graphql_introspect", "GraphQLIntrospector"
        )

    async def _test_oauth(self) -> List[Dict[str, Any]]:
        """Test OAuth/OIDC - endpoint discovery, misconfiguration."""
        return await self._run_python_module(
            "phase2_discovery.oauth_discovery", "OAuthDiscovery"
        )

    async def _test_openapi(self) -> List[Dict[str, Any]]:
        """Test OpenAPI/Swagger - spec discovery, endpoint extraction."""
        return await self._run_python_module(
            "phase2_discovery.openapi_discovery", "OpenAPIDiscovery"
        )

    async def _test_api_endpoints(self) -> List[Dict[str, Any]]:
        """Test REST API endpoints - discovery, method enumeration."""
        return await self._run_python_module(
            "phase2_discovery.api_endpoint_extractor", "APIEndpointExtractor"
        )

    async def _run_python_module(
        self, module_path: str, class_name: str
    ) -> List[Dict[str, Any]]:
        """Run a Python API testing module."""
        findings = []
        try:
            module = __import__(module_path, fromlist=[class_name])
            tester_class = getattr(module, class_name)

            import inspect
            sig = inspect.signature(tester_class.__init__)
            valid_params = set(sig.parameters.keys()) - {"self"}
            kwargs: Dict[str, Any] = {}
            if "target" in valid_params:
                kwargs["target"] = self.target
            if "output_dir" in valid_params:
                kwargs["output_dir"] = str(self.output_dir)
            if "proxy" in valid_params and self.proxy:
                kwargs["proxy"] = self.proxy

            tester = tester_class(**kwargs)

            scan_result = None
            for method_name in ["scan", "run", "discover", "introspect"]:
                if hasattr(tester, method_name):
                    scan_result = await getattr(tester, method_name)()
                    break

            if scan_result and hasattr(scan_result, "findings"):
                for finding in scan_result.findings:
                    fd = finding.to_dict() if hasattr(finding, "to_dict") else {}
                    fd["tool"] = f"python_{class_name}"
                    fd["category"] = "api_security"
                    findings.append(fd)

        except Exception as e:
            logger.error(f"Python module {class_name} failed: {e}")

        return findings


async def main():
    parser = argparse.ArgumentParser(
        description="SHADOW API Security Suite - GraphQL, OAuth, OpenAPI, REST testing",
    )
    parser.add_argument("-t", "--target", required=True, help="Target URL")
    parser.add_argument("-o", "--output", default="results", help="Output directory")
    parser.add_argument("--modules", help="Modules (comma-separated: graphql,oauth,openapi,api_endpoints)")
    parser.add_argument("--cookie", help="Auth cookie string")
    parser.add_argument("--auth-header", help="Authorization header value")
    parser.add_argument("--timeout", type=int, default=300, help="Timeout in seconds")
    parser.add_argument("--proxy", help="Proxy URL")
    parser.add_argument("--json", action="store_true", help="Output as JSON")

    args = parser.parse_args()
    ensure_dir(args.output)

    modules = args.modules.split(",") if args.modules else None

    suite = APISuite(
        target=args.target,
        output_dir=args.output,
        modules=modules,
        cookie=args.cookie,
        auth_header=args.auth_header,
        timeout=args.timeout,
        proxy=args.proxy,
    )

    result = await suite.run()

    if args.json:
        print(result.to_json())
    else:
        print(f"\nAPI Security Suite: {len(result.findings)} findings")
        print(f"Modules tested: {', '.join(result.parsed_data.get('modules_tested', []))}\n")
        for finding in result.findings:
            sev = finding.get("severity", "?").upper()
            title = finding.get("title", "Unknown")
            tool = finding.get("tool", "?")
            print(f"  [{sev}] {title} ({tool})")


if __name__ == "__main__":
    asyncio.run(main())
